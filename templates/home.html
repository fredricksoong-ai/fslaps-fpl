{% extends "base.html" %}

{% block title %}FPL Analyzer - Home{% endblock %}

{% block head %}
{{ super() }}

<style>
body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

/* --- UPDATED INSIGHTS STYLES --- */

.insights-section {
    margin-bottom: 1.5rem;
    border: 1px solid #d1fae5;
    background: #f0fdfa;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
}

.headline-banner {
    background: none;
    padding: 0;
    color: #0f766e;
    font-style: normal;
    font-size: 0.875rem;
    line-height: 1.4;
    font-weight: 500;
}

/* üèÜ THE FIX: Aggressively zero out margins on the <p> and <ul> */

/* Target the paragraph containing "AI Insights:" and zero its vertical margins */
.headline-banner p.headlines-text {
    margin-top: 0 !important;
    margin-bottom: 0 !important;
}

/* Target the bulleted list and zero its margins, only adding a small space at the top */
.headline-banner ul {
    margin-top: 0.25rem !important; /* Small space after the bold title */
    margin-bottom: 0 !important;
    padding-left: 0 !important; /* Ensure the list starts at the expected position */
    list-style-position: outside; /* Standard list positioning */
}

/* Style for individual list items */
.headline-banner li {
    font-weight: 500;
    line-height: 1.5;
    margin-left: 1.5rem; /* Indent the bullet from the edge of the banner */
    list-style-type: disc;
}

/* --- END UPDATED INSIGHTS STYLES --- */

</style>

{% endblock %}

{% block content %}

<div class="position-section border rounded-xl shadow-lg bg-white mb-8">
    
    <div class="px-4 pt-4">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Overall Top 10 Players (Total Points)</h2>
    </div>

    {% if headlines and headlines.Overall %}
    <div class="insights-section mx-4 mb-4">
        <div class="headline-banner">
        <p class="headlines-text" style="
            margin-bottom: 5px;
            ">
                <strong>AI Insights:</strong> 
            </p>
            
            <ul style="
                margin-top: 5px;
                ">
                {% for insight in headlines.Overall %}
                <li>
                    <em>{{ insight }}</em>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}

    <div class="px-4 pb-4">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-100 sticky top-0 z-10 shadow-sm">
            <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Player</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Team</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Position</th>
            <th class="px-4 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider">Cost</th>
            <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider bg-gray-200 text-gray-800">Points</th>
            <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider bg-gray-200 text-gray-800">Ownership %</th>
            <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider bg-gray-200 text-gray-800">Form</th>
            <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider bg-gray-200 text-gray-800">Clean Sheets</th>
            <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider bg-gray-200 text-gray-800">Value Metric</th>
            <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider bg-gray-200 text-gray-800">Pts/¬£m</th>
            </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
            {% for player in overall_top_10 %}
            <tr class="{% if loop.index is odd %}bg-gray-50{% else %}bg-white{% endif %} hover:bg-gray-100">
            <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">{{ player.web_name }}</td>
            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">{{ player.team_name }}</td>
            <td class="px-4 py-2 whitespace-nowrap text-sm font-semibold text-gray-500">{{ player.position }}</td>
            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 font-semibold text-right">¬£{{ player.now_cost }}</td>

                    {% set max_points = global_max_values.max_points | default(250) %}
                    {% set points_ratio = player.total_points / max_points %}
                    {% set alpha = (points_ratio * 0.8 + 0.15) | round(2) %}
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700 font-bold text-right"
                        style="background-color: rgba(107, 114, 128, {{ alpha }});">
                        {{ player.total_points }}
                    </td>

                    {% set max_ownership = global_max_values.max_ownership | default(40) %}
                    {% set ownership_ratio = player.selected_by_percent / max_ownership %}
                    {% set alpha = (ownership_ratio * 0.8 + 0.15) | round(2) %}
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-right"
                        style="background-color: rgba(107, 114, 128, {{ alpha }});">
                        {{ player.selected_by_percent }}%
                    </td>

                    {% set max_form = global_max_values.max_form | default(15) %}
                    {% set form_ratio = player.form / max_form %}
                    {% set alpha = (form_ratio * 0.8 + 0.15) | round(2) %}
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700 font-bold text-right"
                        style="background-color: rgba(107, 114, 128, {{ alpha }});">
                        {{ player.form }}
                    </td>

                    {% set max_cs = global_max_values.max_cs | default(10) %}
                    {% set cs_ratio = player.clean_sheets / max_cs %}
                    {% set alpha = (cs_ratio * 0.8 + 0.15) | round(2) %}
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700 text-right"
                        style="background-color: rgba(107, 114, 128, {{ alpha }});">
                        {{ player.clean_sheets }}
                    </td>


                    {% if player.position == 'GK' %}
                        {% set value_metric = player.save_value_per_million %}
                        {% set max_value = global_max_values.max_saves_pm | default(30) %}
                    {% else %}
                        {% set value_metric = player.expected_goal_involvements %}
                        {% set max_value = global_max_values.max_xgi | default(20) %}
                    {% endif %}
                    {% set value_ratio = value_metric / max_value %}
                    {% set alpha = (value_ratio * 0.8 + 0.15) | round(2) %}
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-bold text-right"
                        style="background-color: rgba(107, 114, 128, {{ alpha }});">
                        {{ value_metric }}
                    </td>

                    {% set max_ppm = global_max_values.max_ppm | default(30) %}
                    {% set ppm_ratio = player.points_per_million / max_ppm %}
                    {% set alpha = (ppm_ratio * 0.8 + 0.15) | round(2) %}
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700 font-medium text-right"
                        style="background-color: rgba(107, 114, 128, {{ alpha }});">
                        {{ player.points_per_million }}
                    </td>

                </tr>
            {% endfor %}
            </tbody>



        </table>
    </div>

</div>

<div class="space-y-8">
{% for position, players in analysis_data.items() %}
{% set pos_maxes = positional_max_values[position] %}

<div class="position-section border rounded-xl shadow-lg bg-white">
    
    <div class="px-4 pt-4">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">{{ position }}s</h2>
    </div>

    {% if headlines and headlines[position] %}
    <div class="insights-section mx-4 mb-4">
        <div class="headline-banner">
        <p class="headlines-text" style="
            margin-bottom: 5px;
            ">
                <strong>AI Insights:</strong> 
            </p>
            
            <ul style="
                margin-top: 5px;
                ">
                {% for insight in headlines[position] %}
                <li>
                    <em>{{ insight }}</em>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}

    <div class="px-4 pb-4">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-100 sticky top-0 z-10 shadow-sm">
            <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Player</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Team</th>
            <th class="px-4 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider">Cost</th>
            <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider bg-gray-200 text-gray-800">Points</th>
            <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider bg-gray-200 text-gray-800">Ownership %</th>
            <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider bg-gray-200 text-gray-800">Form</th>
            <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider bg-gray-200 text-gray-800">Clean Sheets</th>

            {% if position == 'Goalkeeper' %}

            <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider bg-gray-200 text-gray-800">Saves/¬£m</th>
            {% else %}
            <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider bg-gray-200 text-gray-800">xGI</th>
            {% endif %}
            <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider bg-gray-200 text-gray-800">Pts/¬£m</th>
            </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
            {% for player in players %}
            <tr class="{% if loop.index is odd %}bg-gray-50{% else %}bg-white{% endif %} hover:bg-gray-100">
            <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">{{ player.web_name }}</td>
            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">{{ player.team_name }}</td>
            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 font-semibold text-right">¬£{{ player.now_cost }}</td>

            {% set max_points = pos_maxes.max_points | default(1) %}
            {% set points_ratio = player.total_points / max_points %}
            {% set alpha = (points_ratio * 0.8 + 0.15) | round(2) %}

            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700 font-bold text-right"
            style="background-color: rgba(107, 114, 128, {{ alpha }});"> {{ player.total_points }}
            </td>

            {% set max_ownership = pos_maxes.max_ownership | default(1) %}
            {% set ownership_ratio = player.selected_by_percent / max_ownership %}
            {% set alpha = (ownership_ratio * 0.8 + 0.15) | round(2) %}

            <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-right"
            style="background-color: rgba(107, 114, 128, {{ alpha }});"> {{ player.selected_by_percent }}%
            </td>

            {% set max_form = pos_maxes.max_form | default(1) %}
            {% set form_ratio = player.form / max_form %}
            {% set alpha = (form_ratio * 0.8 + 0.15) | round(2) %}

            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700 font-bold text-right"
            style="background-color: rgba(107, 114, 128, {{ alpha }});"> {{ player.form }}
            </td>

            {% set max_cs = pos_maxes.max_cs | default(1) %}
            {% set cs_ratio = player.clean_sheets / max_cs %}
            {% set alpha = (cs_ratio * 0.8 + 0.15) | round(2) %}

            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700 text-right"
            style="background-color: rgba(107, 114, 128, {{ alpha }});"> {{ player.clean_sheets }}
            </td>

            {% if position == 'Goalkeeper' %}
            {% set value_metric = player.save_value_per_million %}
            {% else %}
            {% set value_metric = player.expected_goal_involvements %}
            {% endif %}
            {% set max_value = pos_maxes.max_value_metric | default(1) %}
            {% set value_ratio = value_metric / max_value %}
            {% set alpha = (value_ratio * 0.8 + 0.15) | round(2) %}

            <td class="px-4 py-2 whitespace-nowrap text-sm font-bold text-right"
            style="background-color: rgba(107, 114, 128, {{ alpha }});"> {{ value_metric }}
            </td>

            {% set max_ppm = pos_maxes.max_ppm | default(1) %}
            {% set ppm_ratio = player.points_per_million / max_ppm %}
            {% set alpha = (ppm_ratio * 0.8 + 0.15) | round(2) %}

            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700 font-medium text-right"
            style="background-color: rgba(107, 114, 128, {{ alpha }});"> {{ player.points_per_million }}
            </td>

            </tr>
            {% endfor %}

            </tbody>

        </table>
    </div>

</div>
{% endfor %}
</div>

{% endblock %}